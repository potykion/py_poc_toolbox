pre-commit
##########

`pre-commit`_ - либа, позволяющая делать pre-commit хуки - запускать команды,
выполнение которых необходимо осуществить до совершения коммита,
если команда завершилась ошибкой, то коммит не осуществляется.
Примерами таких команд могут быть: прогон тестов, форматирование кода, линтинг, проверка типов.


Установка
**********

1. Как обычно, ставим через pip: ``pip install pre-commit``

2. Создаем конфиг ``.pre-commit-config.yaml``, в котором описываются команды для запуска

3. Для включения хука юзаем ``pre-commit install`` (запустить достаточно один раз)


Пример конфига
**************

Сделаем хуки на на форматирование с помощью `black`_ и запуск тестов с помощью `pytest`_:

.. code-block:: yaml

    # при неудачном запуске хука, последующие хуки не выполняются
    fail_fast: true
    # хуки
    repos:
    -   repo: https://github.com/ambv/black
        rev: stable
        hooks:
        - id: black
          args: [--line-length=88, --safe]
          language_version: python3.6
    -   repo: local
        hooks:
        - id: pytest
          name: pytest
          entry: pipenv run pytest tests -x
          pass_filenames: false
          language: system


Хук представляет из себя ссылку на репозиторий, где размещен хук (удаленный или локальный),
и набор настроек хука (команда для выполнения, среда выполнения и т.д.).
В случае с удаленным репозиторием, инфу о настройках зачастую предоставляет сам автор хука,
с локальными надо повозиться.

Обычно хуки, типа линтеров или форматтеров, не требуют дополнительных зависимостей,
для тестирования же нужны все зависимости проекта. Чтобы подсосать зависимости,
можно прописать миллион зависимостей с помощью опции ``additional_dependencies``,
но лучше юзать кастомную среду выполнения (``language: system``) и подтягивать зависимости с помощью `pipenv`_.

Запуск
******

Если руки прямые, то все должно запуститься автоматом при коммите.

Также можно запустить хуки вручную: ``pre-commit run -a``


.. _pre-commit: https://pre-commit.com
.. _black: https://github.com/ambv/black
.. _pytest: https://pytest.org
.. _pipenv: https://github.com/pypa/pipenv